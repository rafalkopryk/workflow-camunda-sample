using Camunda.Connector.SDK.Core.Impl.Inbound;
using Camunda.Connector.SDK.Core.Impl.Inbound.Correlation;
using Camunda.Connector.SDK.Runtime.Inbound;
using Camunda.Connector.SDK.Runtime.Inbound.Importer.File;
using FluentAssertions;
using Moq;
using System.Text;

namespace Camunda.Connector.SDK.Runtime.Tests
{
    public class FindInboundConnectors
    {
        [Fact]
        public async Task FindInboundConnectors_ValidBpmnFile_ShouldReturnExpectedInboundConnectorProperties()
        {
            //arrange
            var bpmnProviderMock = new Mock<IBpmnProvider>();
            bpmnProviderMock.Setup(x => x.GetBpmn(It.IsAny<ProcessDefinition>())).ReturnsAsync(GetBpmnFile());
            var bpmnProcessId = "Process_Test";

            var expectedResult = new InboundConnectorProperties[]
            {
                new InboundConnectorProperties
                {
                    BpmnProcessId = bpmnProcessId,
                    CorrelationPoint = new MessageCorrelationPoint(
                        "event.credit.calculations.simulationFinished.v1",
                        "=message.applicationId"),
                    Properties = new Dictionary<string, string>
                    {
                        ["inbound.type"] = "io.camunda:connector-kafka:1",
                        ["inbound.correlationKeyMapping"] = "=message.applicationId",
                        ["subscription.topic"] = "event.credit.calculations.simulationFinished.v1"
                    }
                },
                new InboundConnectorProperties
                {
                    BpmnProcessId = bpmnProcessId,
                    CorrelationPoint = new MessageCorrelationPoint(
                        "event.credit.applications.decisionGenerated.v1",
                        "=message.applicationId"),
                    Properties = new Dictionary<string, string>
                    {
                        ["subscription.topic"] = "event.credit.applications.decisionGenerated.v1",
                        ["inbound.correlationKeyMapping"] = "=message.applicationId",
                        ["inbound.type"] = "io.camunda:connector-kafka:1"
                    }
                },
            };

            //act
            var bpmnFileProcessDefinitionInspector = new BPMNFileProcessDefinitionInspector(bpmnProviderMock.Object);
            var result = await bpmnFileProcessDefinitionInspector.FindInboundConnectors(new ProcessDefinition(default, default, default, bpmnProcessId));

            //assert
            result.Should().HaveCount(expectedResult.Length);

            for (int i = 0; i < result.Length; i++)
            {
                result[i].BpmnProcessId.Should().Be(expectedResult[i].BpmnProcessId);
                result[i].CorrelationPoint.GetId().Should().Be(expectedResult[i].CorrelationPoint.GetId());

                result[i].Properties.Should().BeEquivalentTo(expectedResult[i].Properties);
            }
        }

        private static byte[] GetBpmnFile()
        {
            var data = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<bpmn:definitions xmlns:bpmn=\"http://www.omg.org/spec/BPMN/20100524/MODEL\" xmlns:bpmndi=\"http://www.omg.org/spec/BPMN/20100524/DI\" xmlns:dc=\"http://www.omg.org/spec/DD/20100524/DC\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:di=\"http://www.omg.org/spec/DD/20100524/DI\" xmlns:zeebe=\"http://camunda.org/schema/zeebe/1.0\" xmlns:modeler=\"http://camunda.org/schema/modeler/1.0\" xmlns:camunda=\"http://camunda.org/schema/1.0/bpmn\" id=\"Definitions_1\" targetNamespace=\"http://bpmn.io/schema/bpmn\" exporter=\"Camunda Modeler\" exporterVersion=\"5.8.0\" modeler:executionPlatform=\"Camunda Cloud\" modeler:executionPlatformVersion=\"8.1.0\" camunda:diagramRelationId=\"6d2cb5a8-7b52-46ef-805f-8226eae3aa72\">\r\n  <bpmn:error id=\"Error_0ymsv3s\" name=\"Error_1fk5j9f\" />\r\n  <bpmn:error id=\"Error_1u86wnn\" name=\"Error_0he4en6\" />\r\n  <bpmn:signal id=\"Signal_15r1iun\" name=\"Signal_15r1iun\" />\r\n  <bpmn:message id=\"Message_3pb9ton\" name=\"event.credit.applications.decisionGenerated.v1\">\r\n    <bpmn:extensionElements>\r\n      <zeebe:subscription correlationKey=\"=applicationId\" />\r\n    </bpmn:extensionElements>\r\n  </bpmn:message>\r\n  <bpmn:message id=\"Message_2hb2nh0\" name=\"event.credit.calculations.simulationFinished.v1\">\r\n    <bpmn:extensionElements>\r\n      <zeebe:subscription correlationKey=\"=applicationId\" />\r\n    </bpmn:extensionElements>\r\n  </bpmn:message>\r\n  <bpmn:process id=\"Process_Test\" isExecutable=\"true\">\r\n    <bpmn:serviceTask id=\"Activity_Simulation\" name=\"Simulation\" zeebe:modelerTemplate=\"io.camunda.connectors.KAFKA.v1\" zeebe:modelerTemplateVersion=\"1\" zeebe:modelerTemplateIcon=\"data:image/svg+xml;utf8,%3Csvg width=&#39;18&#39; height=&#39;18&#39; viewBox=&#39;0 0 256 416&#39; xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39;%3E%3Cpath d=&#39;M201.816 230.216c-16.186 0-30.697 7.171-40.634 18.461l-25.463-18.026c2.703-7.442 4.255-15.433 4.255-23.797 0-8.219-1.498-16.076-4.112-23.408l25.406-17.835c9.936 11.233 24.409 18.365 40.548 18.365 29.875 0 54.184-24.305 54.184-54.184 0-29.879-24.309-54.184-54.184-54.184-29.875 0-54.184 24.305-54.184 54.184 0 5.348.808 10.505 2.258 15.389l-25.423 17.844c-10.62-13.175-25.911-22.374-43.333-25.182v-30.64c24.544-5.155 43.037-26.962 43.037-53.019C124.171 24.305 99.862 0 69.987 0 40.112 0 15.803 24.305 15.803 54.184c0 25.708 18.014 47.246 42.067 52.769v31.038C25.044 143.753 0 172.401 0 206.854c0 34.621 25.292 63.374 58.355 68.94v32.774c-24.299 5.341-42.552 27.011-42.552 52.894 0 29.879 24.309 54.184 54.184 54.184 29.875 0 54.184-24.305 54.184-54.184 0-25.883-18.253-47.553-42.552-52.894v-32.775a69.965 69.965 0 0 0 42.6-24.776l25.633 18.143c-1.423 4.84-2.22 9.946-2.22 15.24 0 29.879 24.309 54.184 54.184 54.184 29.875 0 54.184-24.305 54.184-54.184 0-29.879-24.309-54.184-54.184-54.184zm0-126.695c14.487 0 26.27 11.788 26.27 26.271s-11.783 26.27-26.27 26.27-26.27-11.787-26.27-26.27c0-14.483 11.783-26.271 26.27-26.271zm-158.1-49.337c0-14.483 11.784-26.27 26.271-26.27s26.27 11.787 26.27 26.27c0 14.483-11.783 26.27-26.27 26.27s-26.271-11.787-26.271-26.27zm52.541 307.278c0 14.483-11.783 26.27-26.27 26.27s-26.271-11.787-26.271-26.27c0-14.483 11.784-26.27 26.271-26.27s26.27 11.787 26.27 26.27zm-26.272-117.97c-20.205 0-36.642-16.434-36.642-36.638 0-20.205 16.437-36.642 36.642-36.642 20.204 0 36.641 16.437 36.641 36.642 0 20.204-16.437 36.638-36.641 36.638zm131.831 67.179c-14.487 0-26.27-11.788-26.27-26.271s11.783-26.27 26.27-26.27 26.27 11.787 26.27 26.27c0 14.483-11.783 26.271-26.27 26.271z&#39; style=&#39;fill:%23231f20&#39;/%3E%3C/svg%3E\">\r\n      <bpmn:extensionElements>\r\n        <zeebe:taskDefinition type=\"io.camunda:connector-kafka:1\" />\r\n        <zeebe:ioMapping>\r\n          <zeebe:input source=\"*\" target=\"topic.bootstrapServers\" />\r\n          <zeebe:input source=\"command.credit.calculations.simulation.v1\" target=\"topic.topicName\" />\r\n          <zeebe:input source=\"Simulation\" target=\"message.key\" />\r\n          <zeebe:input source=\"={ &#10;  &#34;applicationId&#34;:applicationId,&#10;  &#34;amount&#34;: amount,&#10;  &#34;creditPeriodInMonths&#34;: creditPeriodInMonths,&#10;  &#34;averageNetMonthlyIncome&#34;:averageNetMonthlyIncome&#10;}\" target=\"message.value\" />\r\n        </zeebe:ioMapping>\r\n        <zeebe:taskHeaders />\r\n      </bpmn:extensionElements>\r\n      <bpmn:incoming>Flow_1rfiuri</bpmn:incoming>\r\n      <bpmn:outgoing>Flow_1wyuxuo</bpmn:outgoing>\r\n    </bpmn:serviceTask>\r\n    <bpmn:receiveTask id=\"Activity_SimulationFinished\" name=\"Simulation finished\" messageRef=\"Message_2hb2nh0\">\r\n      <bpmn:extensionElements>\r\n        <zeebe:ioMapping>\r\n          <zeebe:output source=\"=message.decision\" target=\"decision\" />\r\n        </zeebe:ioMapping>\r\n        <zeebe:properties>\r\n          <zeebe:property name=\"inbound.type\" value=\"io.camunda:connector-kafka:1\" />\r\n          <zeebe:property name=\"inbound.correlationKeyMapping\" value=\"=message.applicationId\" />\r\n          <zeebe:property name=\"subscription.topic\" value=\"event.credit.calculations.simulationFinished.v1\" />\r\n        </zeebe:properties>\r\n      </bpmn:extensionElements>\r\n      <bpmn:incoming>Flow_1wyuxuo</bpmn:incoming>\r\n      <bpmn:outgoing>Flow_0mgcb2w</bpmn:outgoing>\r\n    </bpmn:receiveTask>\r\n    <bpmn:serviceTask id=\"Activity_Decision\" name=\"Decision\" zeebe:modelerTemplate=\"io.camunda.connectors.KAFKA.v1\" zeebe:modelerTemplateVersion=\"1\" zeebe:modelerTemplateIcon=\"data:image/svg+xml;utf8,%3Csvg width=&#39;18&#39; height=&#39;18&#39; viewBox=&#39;0 0 256 416&#39; xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39;%3E%3Cpath d=&#39;M201.816 230.216c-16.186 0-30.697 7.171-40.634 18.461l-25.463-18.026c2.703-7.442 4.255-15.433 4.255-23.797 0-8.219-1.498-16.076-4.112-23.408l25.406-17.835c9.936 11.233 24.409 18.365 40.548 18.365 29.875 0 54.184-24.305 54.184-54.184 0-29.879-24.309-54.184-54.184-54.184-29.875 0-54.184 24.305-54.184 54.184 0 5.348.808 10.505 2.258 15.389l-25.423 17.844c-10.62-13.175-25.911-22.374-43.333-25.182v-30.64c24.544-5.155 43.037-26.962 43.037-53.019C124.171 24.305 99.862 0 69.987 0 40.112 0 15.803 24.305 15.803 54.184c0 25.708 18.014 47.246 42.067 52.769v31.038C25.044 143.753 0 172.401 0 206.854c0 34.621 25.292 63.374 58.355 68.94v32.774c-24.299 5.341-42.552 27.011-42.552 52.894 0 29.879 24.309 54.184 54.184 54.184 29.875 0 54.184-24.305 54.184-54.184 0-25.883-18.253-47.553-42.552-52.894v-32.775a69.965 69.965 0 0 0 42.6-24.776l25.633 18.143c-1.423 4.84-2.22 9.946-2.22 15.24 0 29.879 24.309 54.184 54.184 54.184 29.875 0 54.184-24.305 54.184-54.184 0-29.879-24.309-54.184-54.184-54.184zm0-126.695c14.487 0 26.27 11.788 26.27 26.271s-11.783 26.27-26.27 26.27-26.27-11.787-26.27-26.27c0-14.483 11.783-26.271 26.27-26.271zm-158.1-49.337c0-14.483 11.784-26.27 26.271-26.27s26.27 11.787 26.27 26.27c0 14.483-11.783 26.27-26.27 26.27s-26.271-11.787-26.271-26.27zm52.541 307.278c0 14.483-11.783 26.27-26.27 26.27s-26.271-11.787-26.271-26.27c0-14.483 11.784-26.27 26.271-26.27s26.27 11.787 26.27 26.27zm-26.272-117.97c-20.205 0-36.642-16.434-36.642-36.638 0-20.205 16.437-36.642 36.642-36.642 20.204 0 36.641 16.437 36.641 36.642 0 20.204-16.437 36.638-36.641 36.638zm131.831 67.179c-14.487 0-26.27-11.788-26.27-26.271s11.783-26.27 26.27-26.27 26.27 11.787 26.27 26.27c0 14.483-11.783 26.271-26.27 26.271z&#39; style=&#39;fill:%23231f20&#39;/%3E%3C/svg%3E\">\r\n      <bpmn:extensionElements>\r\n        <zeebe:taskDefinition type=\"io.camunda:connector-kafka:1\" retries=\"3\" />\r\n        <zeebe:ioMapping>\r\n          <zeebe:input source=\"*\" target=\"topic.bootstrapServers\" />\r\n          <zeebe:input source=\"command.credit.applications.decision.v1\" target=\"topic.topicName\" />\r\n          <zeebe:input source=\"Decision\" target=\"message.key\" />\r\n          <zeebe:input source=\"={&#10;  &#34;applicationId&#34;: applicationId,&#10;  &#34;decision&#34;: decision&#10;}\" target=\"message.value\" />\r\n        </zeebe:ioMapping>\r\n        <zeebe:taskHeaders />\r\n      </bpmn:extensionElements>\r\n      <bpmn:incoming>Flow_0mgcb2w</bpmn:incoming>\r\n      <bpmn:outgoing>Flow_10ln5na</bpmn:outgoing>\r\n    </bpmn:serviceTask>\r\n    <bpmn:receiveTask id=\"Activity_DecisionGenerated\" name=\"Decision generated\" messageRef=\"Message_3pb9ton\">\r\n      <bpmn:extensionElements>\r\n        <zeebe:properties>\r\n          <zeebe:property name=\"subscription.topic\" value=\"event.credit.applications.decisionGenerated.v1\" />\r\n          <zeebe:property name=\"inbound.correlationKeyMapping\" value=\"=message.applicationId\" />\r\n          <zeebe:property name=\"inbound.type\" value=\"io.camunda:connector-kafka:1\" />\r\n        </zeebe:properties>\r\n      </bpmn:extensionElements>\r\n      <bpmn:incoming>Flow_10ln5na</bpmn:incoming>\r\n      <bpmn:outgoing>Flow_13r5kon</bpmn:outgoing>\r\n    </bpmn:receiveTask>\r\n    <bpmn:sequenceFlow id=\"Flow_1wyuxuo\" sourceRef=\"Activity_Simulation\" targetRef=\"Activity_SimulationFinished\" />\r\n    <bpmn:sequenceFlow id=\"Flow_0mgcb2w\" sourceRef=\"Activity_SimulationFinished\" targetRef=\"Activity_Decision\" />\r\n    <bpmn:sequenceFlow id=\"Flow_10ln5na\" sourceRef=\"Activity_Decision\" targetRef=\"Activity_DecisionGenerated\" />\r\n    <bpmn:startEvent id=\"Event_Start\">\r\n      <bpmn:outgoing>Flow_1rfiuri</bpmn:outgoing>\r\n    </bpmn:startEvent>\r\n    <bpmn:endEvent id=\"Event_End\">\r\n      <bpmn:incoming>Flow_13r5kon</bpmn:incoming>\r\n    </bpmn:endEvent>\r\n    <bpmn:sequenceFlow id=\"Flow_13r5kon\" sourceRef=\"Activity_DecisionGenerated\" targetRef=\"Event_End\" />\r\n    <bpmn:sequenceFlow id=\"Flow_1rfiuri\" sourceRef=\"Event_Start\" targetRef=\"Activity_Simulation\" />\r\n  </bpmn:process>\r\n  <bpmndi:BPMNDiagram id=\"BPMNDiagram_1\">\r\n    <bpmndi:BPMNPlane id=\"BPMNPlane_1\" bpmnElement=\"Process_Test\">\r\n      <bpmndi:BPMNShape id=\"BPMNShape_0ie30e6\" bpmnElement=\"Activity_SimulationFinished\">\r\n        <dc:Bounds x=\"400\" y=\"80\" width=\"100\" height=\"80\" />\r\n        <bpmndi:BPMNLabel />\r\n      </bpmndi:BPMNShape>\r\n      <bpmndi:BPMNShape id=\"BPMNShape_0f5qoq2\" bpmnElement=\"Activity_Decision\">\r\n        <dc:Bounds x=\"580\" y=\"80\" width=\"100\" height=\"80\" />\r\n        <bpmndi:BPMNLabel />\r\n      </bpmndi:BPMNShape>\r\n      <bpmndi:BPMNShape id=\"BPMNShape_0l0ssql\" bpmnElement=\"Activity_Simulation\">\r\n        <dc:Bounds x=\"230\" y=\"80\" width=\"100\" height=\"80\" />\r\n        <bpmndi:BPMNLabel />\r\n      </bpmndi:BPMNShape>\r\n      <bpmndi:BPMNShape id=\"Event_1kr971m_di\" bpmnElement=\"Event_Start\">\r\n        <dc:Bounds x=\"152\" y=\"102\" width=\"36\" height=\"36\" />\r\n      </bpmndi:BPMNShape>\r\n      <bpmndi:BPMNShape id=\"BPMNShape_1k4x8dh\" bpmnElement=\"Activity_DecisionGenerated\">\r\n        <dc:Bounds x=\"740\" y=\"80\" width=\"100\" height=\"80\" />\r\n        <bpmndi:BPMNLabel />\r\n      </bpmndi:BPMNShape>\r\n      <bpmndi:BPMNShape id=\"Event_1s7qbm8_di\" bpmnElement=\"Event_End\">\r\n        <dc:Bounds x=\"882\" y=\"102\" width=\"36\" height=\"36\" />\r\n      </bpmndi:BPMNShape>\r\n      <bpmndi:BPMNEdge id=\"BPMNEdge_1b0y0pa\" bpmnElement=\"Flow_1wyuxuo\">\r\n        <di:waypoint x=\"330\" y=\"120\" />\r\n        <di:waypoint x=\"400\" y=\"120\" />\r\n      </bpmndi:BPMNEdge>\r\n      <bpmndi:BPMNEdge id=\"BPMNEdge_0r2wp0l\" bpmnElement=\"Flow_0mgcb2w\">\r\n        <di:waypoint x=\"500\" y=\"120\" />\r\n        <di:waypoint x=\"580\" y=\"120\" />\r\n      </bpmndi:BPMNEdge>\r\n      <bpmndi:BPMNEdge id=\"BPMNEdge_1ypdgyh\" bpmnElement=\"Flow_10ln5na\">\r\n        <di:waypoint x=\"680\" y=\"120\" />\r\n        <di:waypoint x=\"740\" y=\"120\" />\r\n      </bpmndi:BPMNEdge>\r\n      <bpmndi:BPMNEdge id=\"Flow_13r5kon_di\" bpmnElement=\"Flow_13r5kon\">\r\n        <di:waypoint x=\"840\" y=\"120\" />\r\n        <di:waypoint x=\"882\" y=\"120\" />\r\n      </bpmndi:BPMNEdge>\r\n      <bpmndi:BPMNEdge id=\"Flow_1rfiuri_di\" bpmnElement=\"Flow_1rfiuri\">\r\n        <di:waypoint x=\"188\" y=\"120\" />\r\n        <di:waypoint x=\"230\" y=\"120\" />\r\n      </bpmndi:BPMNEdge>\r\n    </bpmndi:BPMNPlane>\r\n  </bpmndi:BPMNDiagram>\r\n</bpmn:definitions>\r\n";
            return Encoding.UTF8.GetBytes(data);
        }
    }
}